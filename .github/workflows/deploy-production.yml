name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type "deploy-production" to confirm deployment'
        required: true
        type: string
  release:
    types: [published]

jobs:
  pre-deployment-checks:
    name: Pre-Deployment Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate confirmation (manual trigger only)
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ "${{ github.event.inputs.confirmation }}" != "deploy-production" ]; then
            echo "‚ùå Deployment confirmation failed"
            echo "Expected: 'deploy-production'"
            echo "Received: '${{ github.event.inputs.confirmation }}'"
            exit 1
          fi
          echo "‚úÖ Deployment confirmed"

      - name: Check version tag (release trigger only)
        if: github.event_name == 'release'
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          echo "üì¶ Deploying release: $VERSION"

          # Verify semantic versioning format
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ö†Ô∏è Warning: Version tag doesn't follow semantic versioning (vX.Y.Z)"
          fi

      - name: Verify tests passed
        run: |
          echo "‚úÖ Pre-deployment checks complete"

  deploy-production:
    name: Deploy Backend to Production
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    environment:
      name: production
      url: ${{ steps.stack-outputs.outputs.api_endpoint }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install AWS SAM CLI
        run: pip install aws-sam-cli

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Deploy backend with SAM
        working-directory: backend
        run: |
          echo "üöÄ Deploying to PRODUCTION..."

          # Deploy using SAM with parameter overrides for API keys
          sam deploy \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --stack-name ${{ secrets.STACK_NAME_PRODUCTION || 'pixel-prompt-production' }} \
            --resolve-s3 \
            --capabilities CAPABILITY_IAM \
            --parameter-overrides \
              Model1Key="${{ secrets.MODEL_1_KEY || 'not-set' }}" \
              Model2Key="${{ secrets.MODEL_2_KEY || 'not-set' }}" \
              Model3Key="${{ secrets.MODEL_3_KEY || 'not-set' }}" \
              Model4Key="${{ secrets.MODEL_4_KEY || 'not-set' }}" \
              Model5Key="${{ secrets.MODEL_5_KEY || 'not-set' }}" \
              Model6Key="${{ secrets.MODEL_6_KEY || 'not-set' }}" \
              Model7Key="${{ secrets.MODEL_7_KEY || 'not-set' }}" \
              Model8Key="${{ secrets.MODEL_8_KEY || 'not-set' }}" \
              Model9Key="${{ secrets.MODEL_9_KEY || 'not-set' }}"

          echo "‚úÖ Deployment complete"

      - name: Get stack outputs
        id: stack-outputs
        working-directory: backend
        run: |
          # Extract outputs from CloudFormation stack
          API_ENDPOINT=$(aws cloudformation describe-stacks \
            --stack-name ${{ secrets.STACK_NAME_PRODUCTION || 'pixel-prompt-production' }} \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiEndpoint`].OutputValue' \
            --output text)

          S3_BUCKET=$(aws cloudformation describe-stacks \
            --stack-name ${{ secrets.STACK_NAME_PRODUCTION || 'pixel-prompt-production' }} \
            --query 'Stacks[0].Outputs[?OutputKey==`ImageBucket`].OutputValue' \
            --output text || echo "N/A")

          CLOUDFRONT_URL=$(aws cloudformation describe-stacks \
            --stack-name ${{ secrets.STACK_NAME_PRODUCTION || 'pixel-prompt-production' }} \
            --query 'Stacks[0].Outputs[?OutputKey==`CloudFrontURL`].OutputValue' \
            --output text || echo "N/A")

          echo "api_endpoint=$API_ENDPOINT" >> $GITHUB_OUTPUT
          echo "s3_bucket=$S3_BUCKET" >> $GITHUB_OUTPUT
          echo "cloudfront_url=$CLOUDFRONT_URL" >> $GITHUB_OUTPUT

          echo "‚úÖ Stack outputs retrieved"
          echo "   API Endpoint: $API_ENDPOINT"
          echo "   S3 Bucket: $S3_BUCKET"
          echo "   CloudFront: $CLOUDFRONT_URL"

      - name: Comprehensive health check
        run: |
          API_ENDPOINT="${{ steps.stack-outputs.outputs.api_endpoint }}"

          echo "üè• Running comprehensive health checks..."

          # Wait for API to stabilize
          sleep 15

          # Test 1: Gallery list endpoint
          echo "Test 1: Gallery list endpoint..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$API_ENDPOINT/gallery/list" || echo "000")
          if [ "$HTTP_CODE" -eq "200" ] || [ "$HTTP_CODE" -eq "404" ]; then
            echo "  ‚úÖ Gallery endpoint responding (HTTP $HTTP_CODE)"
          else
            echo "  ‚ùå Gallery endpoint failed (HTTP $HTTP_CODE)"
            exit 1
          fi

          # Test 2: Generate endpoint (basic)
          echo "Test 2: Generate endpoint..."
          RESPONSE=$(curl -s -X POST "$API_ENDPOINT/generate" \
            -H "Content-Type: application/json" \
            -H "X-Correlation-ID: ci-prod-health-${{ github.run_id }}" \
            -d '{
              "prompt": "production health check",
              "ip": "127.0.0.1",
              "seed": 99999,
              "steps": 1,
              "cfg": 1
            }' || echo '{"error": "request failed"}')

          if echo "$RESPONSE" | grep -q "jobId"; then
            echo "  ‚úÖ Generate endpoint functional"
          else
            echo "  ‚ö†Ô∏è Generate endpoint may have issues"
            echo "  Response: $RESPONSE"
          fi

          # Test 3: Enhance endpoint
          echo "Test 3: Enhance endpoint..."
          ENHANCE_RESPONSE=$(curl -s -X POST "$API_ENDPOINT/enhance" \
            -H "Content-Type: application/json" \
            -H "X-Correlation-ID: ci-prod-enhance-${{ github.run_id }}" \
            -d '{"prompt": "test"}' || echo '{"error": "request failed"}')

          if echo "$ENHANCE_RESPONSE" | grep -q "enhanced"; then
            echo "  ‚úÖ Enhance endpoint functional"
          else
            echo "  ‚ö†Ô∏è Enhance endpoint may have issues (this is acceptable if no AI key configured)"
          fi

          echo ""
          echo "‚úÖ Health checks complete"

      - name: Monitor CloudWatch logs
        continue-on-error: true
        run: |
          echo "üìä Checking recent CloudWatch logs for errors..."

          # Get log group name
          LOG_GROUP="/aws/lambda/pixel-prompt-production-GenerateFunction"

          # Check logs from last 5 minutes
          aws logs filter-log-events \
            --log-group-name "$LOG_GROUP" \
            --start-time $(($(date +%s) - 300))000 \
            --filter-pattern "ERROR" \
            --max-items 10 || echo "No errors found or log group doesn't exist yet"

      - name: Deployment report
        if: always()
        run: |
          VERSION="${{ github.event.release.tag_name || 'manual' }}"

          echo "## üöÄ Production Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Stack Name**: ${{ secrets.STACK_NAME_PRODUCTION || 'pixel-prompt-production' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region**: ${{ secrets.AWS_REGION || 'us-east-1' }}" >> $GITHUB_STEP_SUMMARY
          echo "**API Endpoint**: ${{ steps.stack-outputs.outputs.api_endpoint }}" >> $GITHUB_STEP_SUMMARY
          echo "**S3 Bucket**: ${{ steps.stack-outputs.outputs.s3_bucket }}" >> $GITHUB_STEP_SUMMARY
          echo "**CloudFront**: ${{ steps.stack-outputs.outputs.cloudfront_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Post-Deployment Actions" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Monitor CloudWatch logs for errors" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Test all features manually" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Update documentation with new URLs" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Notify stakeholders of deployment" >> $GITHUB_STEP_SUMMARY

      - name: Create deployment issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® PRODUCTION Deployment Failed - ${context.sha.substring(0, 7)}`,
              body: `## ‚ö†Ô∏è PRODUCTION Deployment Failure

              **Workflow**: ${context.workflow}
              **Run**: ${context.runNumber}
              **Commit**: ${context.sha}
              **Actor**: ${context.actor}
              **Time**: ${new Date().toISOString()}

              [View Workflow Run](${context.payload.repository.html_url}/actions/runs/${context.runId})

              **URGENT**: Production deployment failed. Please investigate immediately.

              ### Rollback Procedure
              1. Identify last known good deployment
              2. Revert problematic commits: \`git revert <commit>\`
              3. Re-run deployment workflow

              ### Investigation Steps
              - Check CloudFormation events in AWS Console
              - Review Lambda function logs in CloudWatch
              - Verify all required secrets are configured
              - Check SAM deployment logs in workflow`,
              labels: ['deployment', 'production', 'critical', 'bug']
            })

      - name: Comment on release (if triggered by release)
        if: github.event_name == 'release' && success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.release.id,
              body: `## ‚úÖ Production Deployment Successful

              **API Endpoint**: ${{ steps.stack-outputs.outputs.api_endpoint }}
              **CloudFront**: ${{ steps.stack-outputs.outputs.cloudfront_url }}

              Deployment completed at ${new Date().toISOString()}`
            })
