name: Deploy to Staging

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy-staging:
    name: Deploy Backend to Staging
    runs-on: ubuntu-latest
    # Only deploy if tests pass
    needs: []

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install AWS SAM CLI
        run: pip install aws-sam-cli

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Deploy backend with SAM
        working-directory: backend
        run: |
          # Deploy using SAM with parameter overrides for API keys
          sam deploy \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --stack-name ${{ secrets.STACK_NAME_STAGING || 'pixel-prompt-staging' }} \
            --resolve-s3 \
            --capabilities CAPABILITY_IAM \
            --parameter-overrides \
              Model1Key="${{ secrets.MODEL_1_KEY || 'not-set' }}" \
              Model2Key="${{ secrets.MODEL_2_KEY || 'not-set' }}" \
              Model3Key="${{ secrets.MODEL_3_KEY || 'not-set' }}" \
              Model4Key="${{ secrets.MODEL_4_KEY || 'not-set' }}" \
              Model5Key="${{ secrets.MODEL_5_KEY || 'not-set' }}" \
              Model6Key="${{ secrets.MODEL_6_KEY || 'not-set' }}" \
              Model7Key="${{ secrets.MODEL_7_KEY || 'not-set' }}" \
              Model8Key="${{ secrets.MODEL_8_KEY || 'not-set' }}" \
              Model9Key="${{ secrets.MODEL_9_KEY || 'not-set' }}"

      - name: Get stack outputs
        id: stack-outputs
        working-directory: backend
        run: |
          # Extract outputs from CloudFormation stack
          API_ENDPOINT=$(aws cloudformation describe-stacks \
            --stack-name ${{ secrets.STACK_NAME_STAGING || 'pixel-prompt-staging' }} \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiEndpoint`].OutputValue' \
            --output text)

          echo "api_endpoint=$API_ENDPOINT" >> $GITHUB_OUTPUT
          echo "‚úÖ API Endpoint: $API_ENDPOINT"

      - name: Health check
        run: |
          API_ENDPOINT="${{ steps.stack-outputs.outputs.api_endpoint }}"

          # Wait for API to be ready
          echo "‚è≥ Waiting for API to be ready..."
          sleep 10

          # Basic health check
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$API_ENDPOINT/gallery/list" || echo "000")

          if [ "$HTTP_CODE" -eq "200" ]; then
            echo "‚úÖ API is responding (HTTP $HTTP_CODE)"
          else
            echo "‚ùå API health check failed (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: Smoke test
        continue-on-error: true
        run: |
          API_ENDPOINT="${{ steps.stack-outputs.outputs.api_endpoint }}"

          # Simple smoke test - try to generate an image
          echo "üß™ Running smoke test..."

          RESPONSE=$(curl -s -X POST "$API_ENDPOINT/generate" \
            -H "Content-Type: application/json" \
            -H "X-Correlation-ID: ci-smoke-test-${{ github.run_id }}" \
            -d '{
              "prompt": "a simple test image",
              "ip": "127.0.0.1",
              "seed": 12345,
              "steps": 1,
              "cfg": 1
            }' || echo '{"error": "request failed"}')

          echo "Response: $RESPONSE"

          # Check if response contains jobId
          if echo "$RESPONSE" | grep -q "jobId"; then
            echo "‚úÖ Smoke test passed - API is functional"
          else
            echo "‚ö†Ô∏è Smoke test warning - API may not be fully functional"
          fi

      - name: Deployment summary
        if: always()
        run: |
          echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: Staging" >> $GITHUB_STEP_SUMMARY
          echo "**Stack Name**: ${{ secrets.STACK_NAME_STAGING || 'pixel-prompt-staging' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region**: ${{ secrets.AWS_REGION || 'us-east-1' }}" >> $GITHUB_STEP_SUMMARY
          echo "**API Endpoint**: ${{ steps.stack-outputs.outputs.api_endpoint }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      - name: Create deployment issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `‚ùå Staging Deployment Failed - ${context.sha.substring(0, 7)}`,
              body: `## Deployment Failure

              **Workflow**: ${context.workflow}
              **Run**: ${context.runNumber}
              **Commit**: ${context.sha}
              **Actor**: ${context.actor}
              **Time**: ${new Date().toISOString()}

              [View Workflow Run](${context.payload.repository.html_url}/actions/runs/${context.runId})

              Please investigate the failure and redeploy.`,
              labels: ['deployment', 'staging', 'bug']
            })
