#!/usr/bin/env node

/**
 * Update frontend .env file with API endpoint from CloudFormation stack
 * Usage: node scripts/update-frontend-env.js [stack-name]
 */

const { execFileSync } = require('child_process');
const fs = require('fs');
const path = require('path');

// Get stack name from command line or default to prod
const stackName = process.argv[2] || 'pixel-prompt-prod';

// Validate stack name to prevent injection (alphanumeric, hyphens, underscores only)
if (!/^[a-zA-Z0-9_-]+$/.test(stackName)) {
  console.error('‚ùå Error: Invalid stack name. Only alphanumeric characters, hyphens, and underscores allowed.');
  process.exit(1);
}

console.log(`\nüîç Fetching API endpoint from stack: ${stackName}...`);

try {
  // Get API endpoint from CloudFormation stack outputs
  // Use execFileSync to avoid shell injection - args passed directly to AWS CLI
  const apiEndpoint = execFileSync('aws', [
    'cloudformation',
    'describe-stacks',
    '--stack-name',
    stackName,
    '--query',
    'Stacks[0].Outputs[?OutputKey==`ApiEndpoint`].OutputValue',
    '--output',
    'text'
  ], { encoding: 'utf-8' }).trim();

  if (!apiEndpoint) {
    console.error('‚ùå Error: Could not find ApiEndpoint in stack outputs');
    console.error(`   Make sure the stack "${stackName}" exists and has deployed successfully`);
    process.exit(1);
  }

  console.log(`‚úÖ Found API endpoint: ${apiEndpoint}`);

  // Path to frontend .env file
  const envPath = path.join(__dirname, '..', 'frontend', '.env');

  // Create .env content
  const envContent = `# Auto-generated by update-frontend-env.js
# Last updated: ${new Date().toISOString()}

VITE_API_ENDPOINT=${apiEndpoint}
`;

  // Write to .env file
  fs.writeFileSync(envPath, envContent, 'utf-8');

  console.log(`‚úÖ Updated ${envPath}`);
  console.log('\nüìù Frontend .env file contents:');
  console.log('‚îÄ'.repeat(50));
  console.log(envContent);
  console.log('‚îÄ'.repeat(50));
  console.log('\n‚ú® Done! You can now run the frontend with the updated API endpoint.');

} catch (error) {
  console.error('\n‚ùå Error updating .env file:');
  console.error(error.message);
  console.error('\nMake sure:');
  console.error('  1. AWS CLI is installed and configured');
  console.error(`  2. Stack "${stackName}" exists and is deployed`);
  console.error('  3. You have permissions to describe CloudFormation stacks');
  process.exit(1);
}
